{% extends 'base.html'%}
{% load static %}

{% block content %}
    {{ STRIPE_PUBLIC_KEY | json_script:"id_stripe_public_key" }}
    {{ client_secret|json_script:"id_client_secret" }}
    <div class="d-flex justify-content-center h-100">
        <div class="checkout">
            <div class="d-flex justify-content-center">
                <h3 id="form-title">Checkout</h3>
            </div>
            <div class="d-flex justify-content-center form_container">
                <form id="payment_form" method="POST" action="">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="mt-2 input-group">
                        <div class="input-group-append w-50 mt-2">                                
                                {{ field.label }}
                        </div>
                        <div class="mt-2 ">
                            {{ field }}
                        </div>
                    </div>
                    {% endfor %}
                    <div class="mt-2 input-group">
                        <div id="card-element" class="form-control">
                        </div>
                    </div>
                    <div class="d-flex justify-content-center mt-3 purchase_container">
                        <button id="submit" class="btn btn-success">Purchase</button>
                    </div>
                </form>
                </div>
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
			</div>
		</div>
	</div>
<script type="text/javascript">
    let stripe_pk = $("#id_stripe_public_key").text().slice(1, -1);
    let clientSecret = $("#id_client_secret").text().slice(1, -1);
    console.log(clientSecret)
    var stripe = Stripe(stripe_pk);
    var elements = stripe.elements();
    var style = {
        base: {
            color: "#32325d",
        }
    };
    

    var card = elements.create("card", { style: style });
    card.mount("#card-element");

    var form = document.getElementById('payment_form');

    form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        stripe.confirmCardPayment(clientSecret, {
            payment_method: {
            card: card,
            billing_details: {
                name: 'Jenny Rosen'
            }
            }
        }).then(function(result) {
            if (result.error) {
            // Show error to your customer (e.g., insufficient funds)
            console.log(result.error.message);
            } else {
            // The payment has been processed!
            if (result.paymentIntent.status === 'succeeded') {
                // Show a success message to your customer
                // There's a risk of the customer closing the window before callback
                // execution. Set up a webhook or plugin to listen for the
                // payment_intent.succeeded event that handles any business critical
                // post-payment actions.
                }
            }
        });
    });
</script>
{% endblock %}