{% extends 'base.html'%}
{% load static %}

{% block content %}
    {{ STRIPE_PUBLIC_KEY | json_script:"id_stripe_public_key" }}
    {{ client_secret|json_script:"id_client_secret" }}
    <div class="d-flex justify-content-center h-100">
        <div class="checkout">
            <div class="d-flex justify-content-center">
                <h3 id="form-title">Checkout</h3>
            </div>
            <div class="row">

                <div class="col-md-4 order-md-2 mb-4">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Your cart</span>
                        <span class="badge badge-secondary badge-pill">{{ products | length }}</span>
                    </h4>
                    <ul class="list-group mb-3 sticky-top">
                        {% for product in products %}
                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                            <div>
                                <h6 class="my-0 uppercase">{{ product.name}}</h6>
                                <small class="text-muted">{{ product.quantity }}</small>
                                <small class="text-muted">{{ product.color }}</small>
                            </div>
                            <span class="text-muted">{{ product.item_total_price | floatformat:2 }}</span>
                        </li>
                        {% endfor %}
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total (USD)</span>
                            <strong>{{ request.session.grand_total |floatformat:2 }}</strong>
                        </li>
                    </ul>
                </div>
                <div class="col-md-8 order-md-1">
                    <h4 class="mb-3">Billing address</h4>
                    <form id="payment_form" method="POST" action="{% url 'checkout_process' %}">
                        <div class="row">
                        {% csrf_token %}
                            {% for field in form %}
                            
                                <div class="col-md-6 mb-3">
                                    {{ field.label }}
                                    {{ field }}
                                    <div class="invalid-feedback"> Valid first name is required. </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="mt-2 input-group">
                            <div id="card-element" class="form-control">
                            </div>
                        </div>
                        <div class="card-errors"></div>
                        <div class="d-flex justify-content-center mt-3 purchase_container">
                            <button id="submit" class="btn btn-success btn-lg btn-block">Purchase</button>
                        </div>
                    </form>
                    
                </div>
                
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
			</div>
		</div>
	</div>
<script type="text/javascript">
    let stripe_pk = $("#id_stripe_public_key").text().slice(1, -1);
    let clientSecret = $("#id_client_secret").text().slice(1, -1);
  
    var stripe = Stripe(stripe_pk);
    var elements = stripe.elements();
    var style = {
        base: {
            color: '#666666',
            fontFamily: 'Philosopher, sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: '#666666',
                fontFamily: 'Philosopher, sans-serif',
                fontSize: '16px',
            }
        },
        invalid: {
            color: '#dc3545',
            iconColor: '#dc3545'
        }
    };
    

    var card = elements.create("card")
    card.mount("#card-element");

    var form = document.getElementById('payment_form');
    
    
    card.addEventListener('change', function (event) {
        var errorDiv = document.getElementById('card-errors');
        if (event.error) {
            var html = `
                <span class="icon" role="alert">
                    <i class="fas fa-times"></i>
                </span>
                <span>${event.error.message}</span>`;
            $(errorDiv).html(html);
        } else {
            errorDiv.textContent = '';
        }
    });

    form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        stripe.createToken(card).then(function(result) {
            if (result.error) {
            // Inform the customer that there was an error.
            var errorElement = document.getElementById('card-errors');
            errorElement.textContent = result.error.message;
            } else {
                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
                var postData = {
                    'csrfmiddlewaretoken': csrfToken,
                    'client_secret': clientSecret,
                    'form': $('#payment_form').serialize(),
                    'token': result.token.id
                };
                var url = '/bag/checkout_process';

                $.post(url, postData).done(function() {
                    stripe.confirmCardPayment(clientSecret, {
                        payment_method: {
                            card: card,
                            billing_details: {
                                name: $.trim(form.firstname),
                                // email: $.trim(form.email.value),
                                // phone: $.trim(form.phone_number.value),
                                // address: {
                                //     line1: $.trim(form.street_address.value),
                                //     city: $.trim(form.town_or_city.value),
                                //     country: $.trim(form.country.value),
                                // }
                            }
                        }
                    }).then(function(result) {
                        if (result.error) {
                        // Show error to your customer (e.g., insufficient funds)
                        console.log(result.error.message);
                        } else {
                        // The payment has been processed!
                        if (result.paymentIntent.status === 'succeeded') {
                            // Show a success message to your customer
                            // There's a risk of the customer closing the window before callback
                            // execution. Set up a webhook or plugin to listen for the
                            // payment_intent.succeeded event that handles any business critical
                            // post-payment actions.
                            }
                        }
                    });
                });
            }
        });

        
    
        
    });
</script>
{% endblock %}